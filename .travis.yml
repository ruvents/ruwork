language: php

git:
    depth: false

sudo: false

cache:
    directories:
        - $HOME/.composer/cache/files
        - $HOME/vendor/bin/.phpunit

env:
    global:
        - PHPUNIT_FLAGS="-v"

install:
    - composer update --prefer-dist --no-interaction
    - bin/phpunit install

script:
    - bin/phpunit

jobs:
    include:
        # Split test
        -
            php: 7.1
            before_install:
                - phpenv config-rm xdebug.ini
            script:
                - bin/splittest

        # Code coverage
        -
            php: 7.2
            script:
                - bin/phpunit -v --coverage-clover=coverage.xml
            after_success:
                - bash <(curl -s https://codecov.io/bash)

        # Symfony LTS 3 and Code Style test
        -
            php: 7.2
            before_install:
                - phpenv config-rm xdebug.ini
                - composer require --no-update symfony/lts:^3
                - composer require --no-update friendsofphp/php-cs-fixer
            script:
                - bin/phpunit
                - vendor/bin/php-cs-fixer fix -v --dry-run --stop-on-violation --using-cache=no

        # Unstable package versions
        -
            php: 7.2
            before_install:
                - phpenv config-rm xdebug.ini
                - composer config minimum-stability dev

        # Publish
        -
            stage: publish
            install: skip
            before_script:
                - echo -e "machine github.com\n  login $GITHUB_API_TOKEN" >> ~/.netrc
            script:
                - ./bin/publish
